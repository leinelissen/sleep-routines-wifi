# Sleep Routines

All connected devices operate over MQTT. The MQTT server is to be hosted from the hub, but may be situated in the cloud for initial prototyping. This document describes all event and data types that make the system.

## Device Types
The device types are the identifiers for the four devices that should be part of the system. The four options are as follows
* `actor`
    * The actual hourglass.
* `sombrero`
    * The bases that are placed at the specific locations where the routine happens.
* `hub`
    * The charging dock
* `app`
    * The bundled application

## Event Types
An event is triggered by one of the devices. An event MUST always contain three properties:
* `event` - the event name
* `deviceType` - the device type identifier as mentioned above
* `deviceUuid` - a unique identifier for single devices - this is currently defined as the ESP32 Wireless MAC address

For brevity, the required properties will no be explicitly named in the list of events:

### `deviceConnected`
This is an announcement to the network that a device has successfully connected. It contains no additional data.

### `deviceDisconnected`
This is an announcement to the network that a device has disconnected. It should be sent as the last message before the device disengages It contains no additional data.

### `deviceDetectedCoupling`
This event is generated by the Sombrero whenever it detects that an actor has been placed on it. It should be captured by the actor, which in turn will open its valve and start the timer. It contains additional data:
* `interval` - The amount of time in milliseconds that the actor is supposed to time when it connects to this particular base

### `deviceDetectedDecoupling`
This event is generated by the Sombrero when the actor is removed from it, after having been connected. It contains no additional data.

### `timerStarted`
This event is generated by the Actor when it starts timing. It is a direct response to the `deviceDetectedCoupling` event. It contains additional data:
* `interval` - A repeat of the time in milliseconds that was captured from the base
* `baseUuid` - A repeat of the respective base’s `deviceUuid` property.

### `timerCompleted`
This event is generated by the Actor when the timer that was set has expired. It will not be generated when the Actor is removed from the Sombrero early. It contains additional data:
* `interval` - A repeat of the time in milliseconds that was captured from the base
* `baseUuid` - A repeat of the respective base’s `deviceUuid` property.

### `timerStopped`
This event is generated by the Actor in direct response to the `deviceDetectedDecoupling` event. It is generated regardless if the timer has been completed or not. It contains additional data:
* `interval` - The time in milliseconds that the timer was supposed to run
* `actualInterval` - The time in milliseconds that the actor has been connected to the base
* `timerWasCompleted` - Whether the timer has been completed or not
* `baseUuid` - A repeat of the respective base’s `deviceUuid` property.

### `updateInterval`
This event is generated by the app whenever the interval for a particular hub has been changed. It is directed towards a particular sombrero
* `interval` - The time in milliseconds that the sombrero should be set to
* `sombreroId` - The particular sombrero it is targeted to

## Limitations
* Since the Actor has no way to directly communicate with the Sombrero, and it has no identification features, the network is limited to having a single Actor. This limitation may be lifted in the future when a multi-pronged connection approach is implemented.
* The system is dependent on a stable and dependable WiFi network
* MQTT is unsecured. It can be setup to 

## TBD
* The intention is to store timer intervals locally on the Sombreros. This requires an implementation of an event that will write these values into memory, and is able to update them.
